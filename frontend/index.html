<!DOCTYPE html>
<html>
  <head>
    <title>Tiny frontend for Crypto Zombies</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.4/dist/web3.min.js"></script>

    <script>
      window.userWeb3 = new Web3(window.ethereum)  // coz may be user already connect his metamask to www
      // the document use cookie to identify if user loggedIn or desired to logout
      // coz of in metamask to true logout user should do so with metamask!
      const metaMaskLoggedInCookie = "metaMaskLoggedIn=true"
      const metaMaskLoggedOutCookie = "metaMaskLoggedIn=false"

      function isMetaMaskLoggedInCookie() {
        return !!document.cookie.split(';').filter((item) => item.includes(metaMaskLoggedInCookie)).length;
      }

      function deleteMetaMaskLoggedInCookie() {
        document.cookie = metaMaskLoggedOutCookie;
      }

      const ethEnabled = async () => {
        if (typeof window.ethereum !== 'undefined') {
          console.log('MetaMask is installed!');
          return true
        }
        return false
      }

      async function loginWithMetaMask() {
        const accounts = await ethereum.request({ method: 'eth_requestAccounts' })
          .catch((e) => {
            console.error('could not login with metamask', e.message)
            return
          })
        if (!accounts) {
          return
        }
        window.userWeb3 = new Web3(window.ethereum)
        document.cookie = metaMaskLoggedInCookie
        console.log("new web3 created", window.userWeb3)
        console.log(await window.userWeb3.eth.getAccounts())
      }

      // first of all in the app should be logic about metamask login
      let authHtml = "";

      const render = async () => {

        // todo: init subscribers
        ethereum.on('accountsChanged', render);
        ethereum.on('disconnect', render);

        if (!await ethEnabled()) {
          authHtml = `
            <div class="container">
              <h1>MetaMask Login</h1>
              <div class="info">MetaMask is not installed or not enabled. Check <a href="https://www.geeksforgeeks.org/how-to-install-and-use-metamask-on-google-chrome/" target="_blank">instruction</a>.</div>
              <button id="loginButtonId" disabled onclick="() => {}">Login is not enabled</button>
            </div>
          `;
        } else {
          authHtml = `
            <div class="container">
              <h1>MetaMask Login</h1>
              <div class="info">Proceed login with Meta Mask.</div>
              <button id="loginButtonId" onclick="handleLogin()">Login</button>
            </div>
          `;
        }

        const accounts = await window.userWeb3.eth.getAccounts()
            .catch((e) => {
              console.error(e.message)
              return
            })

        // below define html blocks which will be in use on success login
        let userHtml = "";
        const target = document.querySelector("#app");

        if (accounts.length && isMetaMaskLoggedInCookie()) {
          const network = await window.userWeb3.eth.net.getNetworkType();
          const userAddress = accounts[0];
          const userBalance = window.userWeb3.utils.fromWei(
            await window.userWeb3.eth.getBalance(userAddress)
          );

          authHtml = `
            <div class="container">
              <h1>Logout</h1>
              <div class="info">The true disconnect functionality is entirely in the user's hands due to security and privacy concerns, but for user-convenience you can check a button below.</div>
              <button onclick="handleLogout()">Logout</button>
            </div>
          `;
          userHtml = `
            <div class="container">
              <h1>Frontend Example for Contract</h1>
              <div class="info">
                <a href="https://testnet.bscscan.com/address/${userAddress}" target="_blank">${userAddress}</a>
              </div>
              <h1>Network</h1>
              <div class="info">${network}</div>
              <h1>Balance</h1>
              <div class="info">${userBalance} ETH</div>
            </div>
          `;
        }
        target.innerHTML =
          authHtml + userHtml;
      };


      const handleLogin = async () => {
        await loginWithMetaMask();
        render()
      }

      const handleLogout = async () => {
        deleteMetaMaskLoggedInCookie();
        render();
      };
    </script>
  </head>

  <body onload="render()">
    <div id="app">
      <div class="container">Loading (awaiting MetaMask login)...</div>
    </div>
  </body>

</html>
